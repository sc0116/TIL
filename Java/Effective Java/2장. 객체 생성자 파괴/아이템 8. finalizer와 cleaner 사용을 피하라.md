# 아이템 8. finalizer와 cleaner 사용을 피하라

---

자바는 두 가지 객체 소멸자를 제공한다.
- **finalizer는 예측할 수 없고, 상황에 따라 위험할 수 있어 일반적으로 불필요하다.**
  - 자바 9에서는 finalizer를 사용 자제(deprecated) API로 지정하고 cleaner를 대안책으로 가져왔다.
- **cleaner는 finalizer보다는 덜 위험하지만, 여전히 예측할 수 없고, 느리고, 일반적으로 불필요하다.**

finalizer와 cleaner는 아래 두 가지 상황에서만 쓰인다.
- 자원의 소유자가 `close` 메서드를 호출하지 않는 것에 대비한 안전망 역할
  - finalizer나 cleaner가 즉시 호출되리라는 보장은 없지만, 클라이언트가 하지 않은 자원 회수를 늦게라도 해주는 것이 아예 안 하는 것보다는 낫다.
- 네이티브 피어와 연결된 객체에서 사용

## finalizer와 cleaner의 문제점

---

### 수행 보장

finalizer와 cleaner는 즉시 수행된다는 보장이 없다.
- **즉, 제때 실행되어야 하는 작업을 finalizer와 cleaner로는 절대 할 수 없다.**
  - 예) 파일 닫기를 finalizer나 cleaner에 맡기면 즉시 닫는다는 보장이 없기 때문에 파일을 계속 열어 둔다면 중대한 오류를 일으킬 수 있다.
- finalizer 스레드는 다른 애플리케이션 스레드보다 우선순위가 낮아서 실행될 기회를 제대로 얻지 못할 수 있다.

finalizer와 cleaner는 수행 시점뿐 아니라 수행 여부조차 보장하지 않는다.
- 따라서 프로그램 생애주기와 상관없는, **상태를 영구적으로 수정하는 작업에서는 절대 finalizer나 cleaner에 의존해서는 안 된다.**
  - 예) 데이터베이스 같은 공유 자원의 영구 락(lock) 해제
- System.gc나 System.runFinalization 메서드는 finalizer와 cleaner가 실행될 가능성을 높여줄 수는 있으나, 보장해주진 않는다.

### 예외 무시

finalizer 동작 중 발생한 예외는 무시되며, 처리할 작업이 남았더라도 그 순간 종료된다.
- 잡지 못한 예외 때문에 해당 객체는 자칫 마무리가 덜 된 상태로 남을 수 있다.
- 훼손된 객체를 다른 스레드가 사용하려 한다면 어떻게 동작할지 예측할 수 없다...

cleaner는 그나마 자신의 스레드를 통제하기 때문에 이러한 문제가 발생하지 않는다.

### 성능 문제

finalizer와 cleaner는 심각한 성능 문제도 동반한다.
- 필자의 컴퓨터에서 `AutoCloseable` 객체를 생성하고 가비지 컬렉터가 수거하기까지 12ns가 걸린 반면, finalizer를 사용하면 550ns가 걸린다.
- 잠시 후 살펴볼 안전망 형태로만 사용하면 훨씬 빨라진다.

### 보안 문제

finalizer를 사용한 클래스는 finalizer 공격에 노출되어 심각한 보안 문제를 일으킬 수도 있다.
- finalizer 공격 원리는 생성자나 직렬화 과정에서 예외가 발생하면, 이 생성되다 만 객체에서 악의적인 하위 클래스의 finalizer가 수행될 수 있게 된다.
- 이 finalizer는 정적 필드에 자신의 참조를 할당하여 가비지 컬렉터가 수집하지 못하게 막을 수 있다.
- **객체 생성을 막으려면 생성자에서 예외를 던지는 것만으로 충분하지만, finalizer가 있다면 그렇지 않다.**

**final이 아닌 클래스를 finalizer 공격으로부터 방어하려면 아무 일도 하지 않는 `finalize` 메서드를 만들고 final로 선언하자.**

## 대안책

---

파일이나 스레드 등 종료해야 할 자원을 담고 있는 객체의 클래스에서 그저 **`AutoCloseable`을 구현해주고, 클라이언트에서 인스턴스를 다 쓰고 나면 `close` 메서드를 호출하면 된다.**
- 각 인스턴스는 자신이 닫혔는지를 추적하는 것이 좋다.
- `close` 메서드에서 이 객체는 더 이상 유효하지 않음을 필드에 기록하고, 다른 메서드는 이 필드를 검사해서 객체가 닫힌 후에 불렸다면 `IllegalStateException`을 던지는 것이다.

## 핵심 정리

---

- cleaner(자바 8까지는 finalizer)는 안전망 역할이나 중요하지 않은 네이티브 자원 회수용으로만 사용하자.
- 물론 이런 경우라도 불확실성과 성능 저하에 주의해야 한다.
